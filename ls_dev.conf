server {
    listen 80;
    server_name ls.dev;
    root /home/app/lilsis/public;

    passenger_enabled on;
    passenger_user app;
    # If this is a Ruby app, specify a Ruby version:
    passenger_ruby /usr/local/rvm/gems/ruby-2.3.3@littlesis/wrappers/ruby;
    # run development mode
    passenger_app_env development;

    error_log /var/log/nginx/error.log notice;

    location ~ ^/app\.php(/|$) {
        root /var/www/littlesis/symfony/web;
        add_header 'Access-Control-Allow-Origin' "$http_origin";
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Mx-ReqToken,X-Requested-With';
        fastcgi_pass php:9000;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        fastcgi_read_timeout 300;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }


    # Network Search    
    location ~ ^/(org|person)/([0-9]+)/.+/networkSearch {
      try_files $uri /app.php$is_args$args;
    }


    location ~ ^/(org|person)/([0-9]+)/.+/merge {
      try_files $uri /app.php$is_args$args;
    }
    
    location ~ ^/list/[0-9]+/.+/(addBulk|matchRelated)$ {
        try_files $uri /app.php$is_args$args;
    }

    location ~ ^/(org|person)/([0-9]+)/.+/recipients$ {
    	 rewrite ^/(org|person)/([0-9]+)/.+/recipients$ /entities/$2?relationships=donation_recipients break;
    }

    # http://littlesis.org/list/852/Top_Fortune_500_companies_in_NYC
    location ~ ^/list/([0-9]+)/(.+)$ {
       rewrite ^/list/([0-9]+)/(.+)$ /lists/$1 break;
    }


    # list 79 is used as the U.S. network
    # and should not be accessible.
    location ~ ^/lists/79-?.*/members$ {
          return 404;
    }


    # rewrite relationship view page from legacy url
    location /relationship/view {
        rewrite ^/relationship/view/id/([0-9]+)$ /relationships/$1 break;
    }


    location /rails/help {
        rewrite ^/rails/help(.*)$ /help$1 last;
    }

    # a bug in symfony produces urls that erroneously includes the port 80
    # This rule handles and redirects those urls
    location ~  ^/littlesis\.org:80/(.*)$ {
        rewrite ^/littlesis\.org:80/(.*)$ /$1 redirect;
    }

    location ~  ^/littlesis\.org/(.*)$ {
        rewrite ^/littlesis\.org/(.*)$ /$1 redirect;
    }

    # route match donations and political pages to rails
            
    # location ~ ^/person/([0-9]+)/.+/matchDonations$ {
    #     rewrite ^/person/([0-9]+)/.+/matchDonations$ /entities/$1/match_donations break;
    # }

    # location ~ ^/person/([0-9]+)/.+/match_ny_donations {
    #     rewrite ^/person/([0-9]+)/.+/match_ny_donations$ /entities/$1/match_ny_donations break;
    # }

    # location ~ ^/person/([0-9]+)/.+/political$ {
    #     rewrite ^/person/([0-9]+)/.+/political$ /entities/$1/political break;
    # }

    
    location /entity {
        try_files $uri /app.php$is_args$args;
    }

    location ~ ^/user/(.+)$ {
        try_files $uri /app.php$is_args$args;
    }

    location /local {
        try_files $uri /app.php$is_args$args;
    }
    
    location /home/contact {
       	rewrite ^/home/contact(.*)$ /flag break;
    }

    location /industry {
        try_files $uri /app.php$is_args$args;
    }

    location ~ ^/reference/(.+)$ {
         try_files $uri /app.php$is_args$args;
    }

    location /advancedhelp {
        try_files $uri /app.php$is_args$args;
    }

    location /beginnerhelp {
        try_files $uri /app.php$is_args$args;
    }

    
    location /disclaimer {
        try_files $uri /app.php$is_args$args;
    }

    location /purpose {
        try_files $uri /app.php$is_args$args;
    }

    location /faq {
        try_files $uri /app.php$is_args$args;
    }

    location /status {
        try_files $uri /app.php$is_args$args;
    }

    location /modification {
        try_files $uri /app.php$is_args$args;
    }

    
    # javascript tests
    location /test/ {
        root /home/app/lilsis;
        autoindex on;
        try_files $uri =404;
    }
}

server {
    listen 80;
    server_name lsapi.dev;
    root /var/www/littlesis/symfony/web;

    location / {
        try_files $uri /app.php$is_args$args;
    }

    location ~ ^/app\.php(/|$) {
        add_header 'Access-Control-Allow-Origin' "$http_origin";
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Mx-ReqToken,X-Requested-With';

        fastcgi_pass php:9000;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        fastcgi_read_timeout 300;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
	}
 }
